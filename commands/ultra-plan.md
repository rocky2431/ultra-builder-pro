---
description: Task planning with intelligent dependency analysis and complexity assessment
argument-hint: [scope]
allowed-tools: Read, Write, Bash, TodoWrite, Grep, Glob, Task
---

# /ultra-plan

## Purpose

Generate task breakdown from complete specifications (created by /ultra-research).

## Pre-Execution Checks

### Specification Completeness Validation

**Check both files exist and are complete**:
- `.ultra/specs/product.md`
- `.ultra/specs/architecture.md`

**Validation criteria**:
- ❌ **BLOCK if**: File has [NEEDS CLARIFICATION] markers
- ❌ **BLOCK if**: File is empty or missing
- ❌ **BLOCK if**: Required sections are missing
- ✅ **PROCEED if**: All sections complete, no markers

**If validation fails**:
```
⚠️  Specifications incomplete

Issues:
- [Specific missing or incomplete sections]

Solution: Run /ultra-research first
```

### Optional Checks

- Check for existing tasks → Ask whether to replace/extend/cancel
- Clarify scope: Full project plan vs specific feature tasks

## Workflow

### 1. Requirements Analysis

**Load specifications**:
- `.ultra/specs/product.md` - User stories, features
- `.ultra/specs/architecture.md` - Technical decisions

**Extract**:
- Functional requirements (product.md §4)
- Technical constraints (architecture.md §2)
- Quality requirements (architecture.md §10)
- Success metrics (product.md §6)

### 2. Codebase Analysis

**Analyze existing codebase for AI-executable context**:

1. **Directory structure**: Identify src/, tests/, config/ patterns
2. **Existing patterns**: Find similar implementations to reference
3. **Tech stack detection**: Framework versions, test runners, build tools
4. **Naming conventions**: File naming, function naming, variable naming

### 3. Task Generation

**Output structure**:
```
.ultra/tasks/
├── tasks.json           # Lightweight registry
└── contexts/
    ├── task-1.md        # Full context for task 1
    ├── task-2.md        # Full context for task 2
    └── ...
```

**tasks.json fields**:

| Field | Purpose |
|-------|---------|
| `id`, `title` | Identification |
| `type` | architecture / feature / bugfix |
| `priority` | P0 / P1 / P2 / P3 |
| `complexity` | 1-10 |
| `status` | pending / in_progress / completed / blocked |
| `dependencies` | Prerequisite task IDs |
| `estimated_days` | Effort estimate |
| `context_file` | Path to context MD file |
| `trace_to` | Spec section reference |

**task-{id}.md structure**:

```markdown
# Task {id}: {title}

> **Status**: pending | **Priority**: P0 | **Complexity**: 4

## Context
**What**: [Clear description]
**Why**: [Business value + Persona/Scenario link]
**Constraints**:
- [Constraint 1]
- [Constraint 2]

## Implementation
**Target Files**:
- `path/to/file.ts` (create)
- `path/to/existing.ts` (modify: description)

**Pattern**: [Reference to existing code]
**Tech Notes**: [Framework/library guidance]

## Acceptance
**Tests**:
- [ ] `test command`
- [ ] Pass: [scenario description]

**Verification**:
```bash
curl -X POST localhost:3000/api/example
```

## Trace
**Source**: `.ultra/specs/product.md#section-id`

## Change Log
| Date | Change | Specs Updated | Reason |
|------|--------|---------------|--------|
| {date} | Initial creation | - | Generated by /ultra-plan |

## Completion
> _Fill when task completed_
- **Completed**: {date}
- **Commit**: {hash}
- **Summary**: {brief description}
```

**Task granularity**:
- Ideal complexity: 3-5 (completable in one session)
- Too large (>6): Break down using ultra-architect-agent
- Too small (<3): Merge with related tasks

### 4. Dependency Analysis

- Build dependency graph
- Detect cycles (error if found)
- Order tasks topologically
- Identify parallel opportunities

### 5. Save Tasks

**Step 1**: Create directory structure:
```bash
mkdir -p .ultra/tasks/contexts
```

**Step 2**: Save tasks.json (lightweight):
```json
{
  "version": "4.4",
  "created": "YYYY-MM-DD HH:mm:ss",
  "tasks": [
    {
      "id": "1",
      "title": "Implement JWT login endpoint",
      "type": "feature",
      "priority": "P0",
      "complexity": 4,
      "status": "pending",
      "dependencies": [],
      "estimated_days": 2,
      "context_file": "contexts/task-1.md",
      "trace_to": ".ultra/specs/product.md#user-authentication"
    }
  ]
}
```

**Step 3**: Generate context file for each task

### 6. Update Project Context

**After tasks saved**:

1. **Update CLAUDE.md** (via syncing-docs skill):
   - Update "Current Focus" section with first pending task

### 7. Report

Output summary:
- Total tasks generated
- Priority distribution (P0/P1/P2)
- Complexity distribution
- Dependency count
- Estimated total effort
- Traceability coverage
- First task details
- Suggest `/ultra-dev` to start

## Quality Standards

- ✅ 100% requirement coverage
- ✅ Clear acceptance criteria for all tasks
- ✅ No circular dependencies
- ✅ Realistic complexity estimates
- ✅ Action-verb task titles

## Integration

- **Prerequisites**: `/ultra-research` (specs must be complete)
- **Skills**: syncing-docs
- **Input**: `.ultra/specs/product.md`, `.ultra/specs/architecture.md`
- **Output**: `.ultra/tasks/tasks.json`, `.ultra/tasks/contexts/*.md`
- **Next**: `/ultra-dev`

**Workflow**:
```
/ultra-init → /ultra-research → /ultra-plan → /ultra-dev
```
